---
title: "Shopify  Data science Challenge"
author: "Taiwo Owoseni"
date: "May 9th 2022"
output:
  pdf_document: default
  html_notebook: default
subtitle: AOV 
---

### **Question**

Given some sample data, write a program to answer the following:[click here to access the required data set](https://docs.google.com/spreadsheets/d/16i38oonuX1y1g7C_UAmiK9GkY7cS-64DfiDMNiR41LM/edit#gid=0)

On Shopify, we have exactly 100 sneaker shops, and each of these shops sells only one model of shoe. We want to do some analysis of the average order value (AOV). When we look at orders data over a 30 day window, we naively calculate an AOV of \$3145.13. Given that we know these shops are selling sneakers, a relatively affordable item, something seems wrong with our analysis. 

1.  Think about what could be going wrong with our calculation. Think about a better way to evaluate this data. 

2.  What metric would you report for this data set?

3.  What is its value?

### Approach

*Here are the list of steps I intend to use to evaluate if the AOV is a good measurement or not:*

-   **Investigating the data set** : Visually understanding the data and look for (filter) outliers.

-   **Observe how AOV vary in 30-days**

-   **Try other metric:** Customer retention?

### **Load Libraries and Data**

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(janitor)
library(tools)
library(scales)
library(broom)
library(MASS)
library(rmarkdown)
library(dplyr)
library(MASS)
library(ggrepel)
library(binom)
library(cohorts)
library(lubridate)

data <- read_csv("data/data.csv")

```

```{r view_data}
head(data)
```

### **Investigating the data set**

-   $$ \text{Calculate unit cost} = \frac{\text{Order Amount}}{\text{Total Items}}$$

-   $$   \text{AOV} = \frac{\text{Summed Order Amount}}{\text{Number of Orders}}$$

```{r naive-aov}
AOV <- sum(data$order_amount)/ nrow(data)
AOV
```

```{r unit cost}
data$unit_cost <- data$order_amount / data$total_items

```

**Expectation**: I assume that the distribution of **unit_co**st is not skewed . My assumption is from the question **"the stores sell the same kind of sneakers**" .

**Result:** The plot below proves that the shops are not selling the sneakers at the an normally distributed price. The plot is right skewed. This indicates presence of outliers in the data. I will plot a box plot to see these outliers in the different payment method.

```{r}
data |>
   ggplot(aes(x= unit_cost)) +
  geom_density(color="darkblue", fill="lightblue") +
  ggtitle('Distribution of Unit cost ') +
  ylab('Density') + 
 xlab('Unit Cost of Sneakers')
```

#### Box Plot : Payment Method

Visually, there are outliers in the data. The box of the boxplot are closer to \$0 unit cost.

```{r box-plot}

data |>
 ggplot(aes(x= payment_method , y= unit_cost)) + 
  geom_boxplot() + 
  ggtitle('Box plot of Payment types') + 
  xlab('Payment Types') + 
  ylab('Unit Cost of Sneakers')
```

**Most expensive Shop**

The cost of a sneaker at **shop 78** is : **25,725 dollars.**

```{r}
data |> filter(unit_cost == max(unit_cost))

```

#### Removing Outliers

```{r remove-outliers }
outliers <- boxplot(data$unit_cost, plot = FALSE)$out
paste0("NUmbers of Outliers: ",  length(outliers))
data_out <- data[!(data$unit_cost %in% outliers), ]
```

I will reproduce the two plot above to see if removing outliers has an effect on **unit cost**, hence have an effect on **AOV.**

**Observation**

There are peaks in the distributions. This could indicate different groups in the shops. The boxplot looks great.

```{r no-outlier-density}
data_out |>
   ggplot(aes(x= unit_cost)) +
  geom_density(color="darkblue", fill="lightblue") +
  ggtitle('Distribution of Unit cost: Without Outliers ') +
  ylab('Density') + 
 xlab('Unit Cost of Sneakers')
```

```{r no-outlier-box-plot}

data_out |>
 ggplot(aes(x= payment_method , y= unit_cost)) + 
  geom_boxplot() +
  ggtitle('Box plot of Payment types: Without Outliers') + 
  xlab('Payment Types') + 
  ylab('Unit Cost of Sneakers')
```

#### Calculate AOV after Outlier removal

The AOV drastically reduced from **\$3,145 to \$300 dollars.**

```{r no-outlier-aov}
AOV_no_outlier <- sum(data_out$order_amount)/ nrow(data_out)
AOV_no_outlier
```

#### H**ow Does the AOV vary in 30-days?**

In other to understand if AOV is a great metric; I will look at how it varied in the month in two cases:

-   **Data with outlier : data**

-   **Data without outlier :data_out**

##### **Data with outlier : data**

The time series for the AOV shows a spike in sales for the Beginning and **end** of the month. For the rest of the month, the spike is somewhat consistent.

```{r time-seires-data}
data$created_at <-as.Date(data$created_at)

#data$date <- as.Date(mdy_hms(data$created_at))
data$date <- as.Date(data$created_at, "%Y%m%d")

aov_data_mth <- data |>
  group_by(created_at)|>
  summarize( aov = sum(order_amount)/n())

 ggplot(aov_data_mth, aes(x= created_at, y= aov)) +
  geom_line() + 
  xlab('Time Created') + 
  ggtitle('TIme Series AOV: With Outliers') + 
  xlab('Payment Types') + 
  ylab('Average Order Value')
```

##### **Data with outlier : data_out**

The time series for the AOV for the data without outlier shows a spike in AOV for the middle of the month. This is opposite of the first time series (the one with outliers). In the **end** of the month, their is a decline in AOV and in the beginning of the month, AOV is small.

```{r time-seires-data-out}

data_out$created_at <-as.Date(data_out$created_at)
data_out$date <- as.Date(data_out$created_at, "%Y%m%d")

aov_data_mth_out <- data_out |>
  group_by(created_at)|>
  summarize( aov = sum(order_amount)/n())

 ggplot(aov_data_mth_out, aes(x= created_at, y = aov)) +
  geom_line() + 
  xlab('Time Created') + 
  ggtitle('TIme Series AOV: Without Outliers') + 
  xlab('Payment Types') + 
  ylab('Average Order Value')
```

\

#### Comments

-   AOV only shows growth in a specific time period. This isn't a great metric. It' very possible that the outliers in the data are not as a result of data entry error. Some stores might be owned by a celebrity and people would love to buy from them. Hence the high order amount.

-   What should matter to the store is if they are able to retain customers. Given the time period of the data set, it would be difficult to calculate customer retention form scratch. I will be using a library called cohort.

**General Retention Rate for all the Shops**

```{r cohort-analysis}

retention_data <- function(data) {
  cohort_days <- data %>%
  cohort_table_day(user_id, date)%>%
   shift_left_pct() %>%
   pivot_longer(-cohort) %>%
   mutate(time = as.numeric(str_remove(name,'t')),
          name = str_replace(name,'t', 'Day'))

   cohort_days[cohort_days == 0] <- NA
   cohort_days
}

```

**Retention with Outliers**

```{r retention-all-shops}

data_cohort <- retention_data(data)
data_cohort_out <- retention_data(data_out)
data_cohort
```

Interpretation of visual isn't clear for the Cohort analysis. I believe if the data spans more months, it will be easier to interpret the cohort analysis visual.

```{r}
ggplot(data_cohort, aes(x = as.factor(name), y = value, color = as.factor(cohort), group = cohort)) + geom_line() + geom_point() + ggtitle('Cohort Analysis for March')
```

**Retention with Outliers**

-   Conclusively, AOV is a good metric but it is easily affected by outliers.

-   Customer retention is also a good metric to use when data has outliers.
